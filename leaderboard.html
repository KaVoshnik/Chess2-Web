<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess2 - Leaderboard</title>
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/leaderboard.css">
  <link rel="stylesheet" href="/css/user_styles.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <meta name="theme-color" content="#1e1e2e">
</head>
<body>
  <header class="navbar">
    <div class="logo">Chess<span>2</span></div>

    <nav id="main-nav">
      <a href="/index.html"><i class="fas fa-home"></i> Home</a>
      <a href="/leaderboard.html" class="active"><i class="fas fa-trophy"></i> Leaderboard</a>
      <a href="/social.html"><i class="fas fa-users"></i> Community</a>
      <a href="/devlog.html"><i class="fas fa-scroll"></i> Blog</a>
    </nav>
    <div class="user-profile">
      <img src="/img/profile.jpg" alt="User Avatar" class="profile-avatar" id="profile-avatar">
      <div class="profile-menu hidden">
        <div class="profile-info">
          <img src="/img/profile.jpg" alt="User Avatar" id="menu-avatar">
          <p class="username" id="username">Guest</p>
        </div>
        <div class="profile-buttons">
          <a href="user_profile.html"><i class="fas fa-user"></i> View Profile</a>
          <a href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>
  </header>

  <main class="leaderboard-page">
    <section class="leaderboard-banner">
      <div class="leaderboard-banner-content">
        <h1><i class="fas fa-trophy"></i> Chess2 Leaderboard</h1>
        <p>Compete with the best players around the world</p>
      </div>
      <div class="leaderboard-banner-visual">
        <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="trophyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#FFD700" />
              <stop offset="100%" stop-color="#FFA500" />
            </linearGradient>
          </defs>
          <path d="M100,20 L130,20 L130,40 L140,40 C150,40 160,50 160,60 L160,80 C160,100 150,110 130,110 L120,110 C115,125 105,135 100,140 C95,135 85,125 80,110 L70,110 C50,110 40,100 40,80 L40,60 C40,50 50,40 60,40 L70,40 L70,20 L100,20 Z" fill="url(#trophyGradient)" stroke="#FFD700" stroke-width="2" />
          <rect x="85" y="140" width="30" height="10" fill="#9eff9e" />
          <rect x="75" y="150" width="50" height="10" fill="#9eff9e" />
          <rect x="70" y="160" width="60" height="10" fill="#9eff9e" />
          <circle cx="70" cy="70" r="15" fill="#1e1e2e" stroke="#FFD700" stroke-width="2" />
          <circle cx="130" cy="70" r="15" fill="#1e1e2e" stroke="#FFD700" stroke-width="2" />
        </svg>
      </div>
    </section>

    <section class="leaderboard-filter-section">
      <div class="filter-dropdown">
        <select id="filter-by">
          <option value="cr">Sort by CR</option>
          <option value="win_rate">Sort by Win Rate</option>
          <option value="total_games">Sort by Games Played</option>
        </select>
      </div>
      <div class="leaderboard-search">
        <input type="text" id="player-search" placeholder="Search player...">
        <button id="search-button"><i class="fas fa-search"></i></button>
      </div>
    </section>

    <section class="leaderboard-container">
      <div class="leaderboard">
        <div class="leaderboard-header-row">
          <div class="leaderboard-col rank"><i class="fas fa-hashtag"></i> Rank</div>
          <div class="leaderboard-col username"><i class="fas fa-user"></i> Player</div>
          <div class="leaderboard-col CR"><i class="fas fa-chart-line"></i> CR</div>
          <div class="leaderboard-col stats"><i class="fas fa-check"></i> Win</div>
          <div class="leaderboard-col stats"><i class="fas fa-times"></i> Loss</div>
          <div class="leaderboard-col stats"><i class="fas fa-handshake"></i> Draw</div>
          <div class="leaderboard-col winrate"><i class="fas fa-percentage"></i> Winrate</div>
          <div class="leaderboard-col games"><i class="fas fa-gamepad"></i> Games</div>
        </div>
        <div id="leaderboard-rows" class="leaderboard-content">
          <div class="leaderboard-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading players data...</p>
          </div>
        </div>
      </div>
    </section>

    <section class="leaderboard-info">
      <div class="info-card">
        <div class="info-icon">
          <i class="fas fa-info-circle"></i>
        </div>
        <div class="info-content">
          <h3>How Rankings Work</h3>
          <p>Player rankings are calculated based on Chess Rating (CR) and performance in matches. Play more games to improve your position!</p>
        </div>
      </div>
      <div class="info-card">
        <div class="info-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <div class="info-content">
          <h3>Not on the Leaderboard?</h3>
          <p>You need to register in order for your account to appear on the leaderboard. Keep playing and climbing the ranks!</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-logo">Chess<span>2</span></div>
      <div class="footer-links">
        <a href="/index.html">Home</a>
        <a href="/leaderboard.html">Leaderboard</a>
        <a href="/social.html">Community</a>
        <a href="/devlog.html">Blog</a>
        <a href="https://github.com/KaVoshnik/Chess_2">GitHub</a>
      </div>
      <div class="footer-social">
        <a href="https://t.me/AdKavoshnik"><i class="fab fa-telegram"></i></a>
        <a href="https://github.com/KaVoshnik/Chess_2"><i class="fab fa-github"></i></a>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Chess2. All rights reserved.</p>
    </div>
  </footer>

  <script src="/js/profile_avatar.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Функция для получения данных игроков
      async function fetchPlayers() {
        try {
          // Показываем индикатор загрузки
          document.getElementById('leaderboard-rows').innerHTML = `
            <div class="leaderboard-loading">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Loading players data...</p>
            </div>
          `;
          
          const response = await fetch('/api/players');
          const players = await response.json();
          
          displayPlayers(players);
          
          // Обработчики для фильтрации и поиска
          document.getElementById('filter-by').addEventListener('change', () => {
            displayPlayers(players);
          });
          
          document.getElementById('player-search').addEventListener('input', () => {
            displayPlayers(players);
          });
          
          document.getElementById('search-button').addEventListener('click', () => {
            displayPlayers(players);
          });
          
        } catch (error) {
          console.error('Error loading data:', error);
          document.getElementById('leaderboard-rows').innerHTML = `
            <div class="leaderboard-error">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Failed to load player data. Please try again later.</p>
            </div>
          `;
        }
      }
      
      // Функция для отображения игроков с учетом фильтров
      function displayPlayers(players) {
        if (!players || players.length === 0) {
          document.getElementById('leaderboard-rows').innerHTML = `
            <div class="leaderboard-empty">
              <i class="fas fa-users-slash"></i>
              <p>No players available yet. Be the first to join!</p>
            </div>
          `;
          return;
        }
        
        // Получаем значения фильтров
        const sortBy = document.getElementById('filter-by').value;
        const searchText = document.getElementById('player-search').value.toLowerCase();
        
        // Фильтруем и сортируем игроков
        let filteredPlayers = players.filter(player => 
          player.username && player.username.toLowerCase().includes(searchText)
        );
        
        // Сортировка
        if (sortBy === 'cr') {
          filteredPlayers.sort((a, b) => (b.cr || 0) - (a.cr || 0));
        } else if (sortBy === 'win_rate') {
          filteredPlayers.sort((a, b) => (b.win_rate || 0) - (a.win_rate || 0));
        } else if (sortBy === 'total_games') {
          filteredPlayers.sort((a, b) => (b.total_games || 0) - (a.total_games || 0));
        }
        
        // Обновляем ранг на основе новой сортировки
        filteredPlayers = filteredPlayers.map((player, index) => ({
          ...player,
          rank: index + 1
        }));
        
        // Отображаем игроков
        const leaderboardRows = document.getElementById('leaderboard-rows');
        leaderboardRows.innerHTML = '';
        
        if (filteredPlayers.length === 0) {
          leaderboardRows.innerHTML = `
            <div class="leaderboard-empty">
              <i class="fas fa-search"></i>
              <p>No players match your search. Try a different query.</p>
            </div>
          `;
          return;
        }
        
        filteredPlayers.forEach((player, index) => {
          const playerRow = document.createElement('div');
          playerRow.className = 'leaderboard-row';
          
          // Добавляем класс для топ-3 игроков
          if (index < 3) {
            playerRow.classList.add(`top-${index + 1}`);
          }
          
          // Создаем аватар игрока на основе имени
          const seed = player.username || 'default';
          const avatarUrl = `/img/profile.jpg`;
                    
          playerRow.innerHTML = `
            <div class="leaderboard-col rank">
              ${index < 3 ? 
                `<div class="top-rank top-${index + 1}">
                   <i class="fas fa-trophy"></i>
                   <span>${index + 1}</span>
                 </div>` 
                : player.rank || '-'}
            </div>
            <div class="leaderboard-col username">
              <div class="player-info">
                <img src="${avatarUrl}" class="player-avatar" alt="${player.username}">
                <span>${player.username || 'Unknown'}</span>
              </div>
            </div>
            <div class="leaderboard-col CR">${player.cr || '0'}</div>
            <div class="leaderboard-col stats wins">${player.wins || '0'}</div>
            <div class="leaderboard-col stats losses">${player.losses || '0'}</div>
            <div class="leaderboard-col stats draws">${player.draws || '0'}</div>
            <div class="leaderboard-col winrate">
              <div class="winrate-bar" style="--win-percent: ${player.win_rate || 0}%;">
                <span>${player.win_rate ? parseFloat(player.win_rate).toFixed(1) : '0.0'}%</span>
              </div>
            </div>
            <div class="leaderboard-col games">${player.total_games || '0'}</div>
          `;
          
          leaderboardRows.appendChild(playerRow);
          
          // Анимируем появление строк
          setTimeout(() => {
            playerRow.classList.add('animate-in');
          }, index * 50);
        });
      }
      
      // Проверяем, авторизован ли пользователь
      const userId = localStorage.getItem('userId');
      const token = localStorage.getItem('token');
      
      // Если пользователь авторизован, обновляем информацию о нем
      if (userId && token) {
        fetch(`/api/user/${userId}`)
          .then(response => {
            if (!response.ok) throw new Error('Failed to fetch user data');
            return response.json();
          })
          .then(userData => {
            const username = userData.username || 'Player';
            document.getElementById('username').textContent = username;
            
            // Генерируем аватар на основе имени пользователя
            const seed = username || 'default';
            const avatarUrl = `https://avatars.dicebear.com/api/identicon/${seed}.svg`;
            
            document.getElementById('profile-avatar').src = avatarUrl;
            document.getElementById('menu-avatar').src = avatarUrl;
          })
          .catch(error => {
            console.error('Error loading user data:', error);
          });
      } else {
        // Если пользователь не авторизован, показываем соответствующую информацию
        document.getElementById('username').textContent = 'Guest';
        document.querySelector('.profile-buttons').innerHTML = `
          <a href="sign_in.html"><i class="fas fa-sign-in-alt"></i> Sign In</a>
          <a href="sign_in.html"><i class="fas fa-user-plus"></i> Register</a>
        `;
      }
      
      // Загружаем данные для таблицы лидеров
      fetchPlayers();
      
      // Анимация для баннера
      setTimeout(() => {
        document.querySelector('.leaderboard-banner').classList.add('animate-in');
      }, 100);
    });
  </script>
</body>
</html>
